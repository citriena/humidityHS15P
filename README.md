# humidityHS15P
 HS15Pを使った湿度測定用 Arduino ライブラリ  

## 概要
秋月電子通商で扱っている[湿度センサ　ＨＳ－１５Ｐ](https://akizukidenshi.com/catalog/g/gI-00117/)を使って湿度を測定するためのArduinoライブラリです。
HS15Pの使い方は、[HS15湿度センサーと簡易回路による湿度計実験](http://siesta.la.coocan.jp/zk/hs15/hs15.html)を基にしています。
一般的なHS15Pの使い方と異なり、外付け部品はHS15Pの他にはコンデンサ１個と温度センサ（＋その周辺部品）のみと非常に少なくて済みます。

## 湿度センサHS15Pの特徴
現在はマイコンで使える精度2～3%の湿度センサが安価に入手できますので、扱いが面倒なHS15Pを今時わざわざ湿度測定に使う必要は少ないでしょうが、私が考えるにこのセンサには以下のように有利な点があります。
1. **高湿度環境に強い。**  
データシートにwater resistiveと書いてあります。operating humidityは20 to 100%RHとなっています。一般目的で私がよく使っているSensirionのSHT-31も0-100%で使えることにはなっていますが、80％以上の高湿度条件で長期間使用すると測定値にオフセットが出るとともにagingが進むと書いてあります。高価なセンサには高湿度環境で長期間使える物があるのかもしれませんが、500円と安価に入手可能な湿度センサでは他にないでしょう。実際に常時80～100%の環境で６年以上使っていますが、劣化による交換は４回で、全て１年以上問題なく使えています。なお、劣化するといずれも極端に低い湿度を示すようになりました。他のセンサもいろいろ試しましたが同様の条件ではどれも３カ月以内に異常値を示すようになりました。

1. **安価**  
1でも書きましたが500円と安価です。ただ、最近は他にも安価なセンサが入手できますので特別安価なわけではありませんが。それでも安価なことは確かです。

1. **ケーブルを長くできる。**  
最近のI2C通信湿度センサはケーブルを長くできません。通常は1m以内、いろいろ対策しても数mです。HS15Pでは使い方によっては数十ｍでも大丈夫です。センサ設置場所に融通が利きます。本湿度センサは温度補正が必要ですので、このような場合は同様にケーブルを長くできるサーミスタ等と一緒に使うのがお勧めです。

当然欠点もあります。

1. **駆動が面倒くさい（ただし、本ライブラリでほぼ解決）。**  
交流駆動で、かつ湿度－抵抗値は指数関数的に変化しますが、抵抗値を対数変換しても直線にはなりません。アナログ手法ではかなりトリッキーなことをしないと十分な精度は期待できそうにありません。ところが[HS15P 湿度センサーの簡易動作実験](http://siesta.la.coocan.jp/zk/hs15/hs15.html)でマイコンを使うことによりHS15Pを非常に簡単に使う方法が開発されました。本ライブラリはその方法を基に開発したライブラリです。

1. **検量線を自分で作成しないといけない（これも本ライブラリでかなり解決）。**  
データシートの湿度－抵抗値図は参考にはなっても私の目的には精度が低すぎて使い物になりませんでした（駆動方法の違いの影響があるのかもしれませんが）。精度を高めるには自分で検量線を引く必要があります。ところが温度で出力が大きく変わるので、検量線の作成は非常に面倒です。ですが、本ライブラリは私が（苦労して）作成した検量線の変換式を使っていますので、検量線を作成する必要はありません（個体ごとの校正はやった方が良いですが）。もっと良い変換式を作成されたら是非提供してください。

1. **反応が遅い。**  
分単位での遅延があります。

1. **低湿度環境で精度が劣る。**  
これはHS15Pのような抵抗変化型湿度センサの欠点のようです。ただ３０％以下でなければ問題ありません。

1. **（たぶん）既に製造終了**  
私が知る限り秋月電子通商でしか入手できません。商品ページを見ると2020年9月時点で3000個弱の在庫があるようなので、当面は入手できるとは思います。

ということで、HS15Pを使う上で面倒な１と２はこのライブラリを使うことでほぼ解決します。
測定器本体と湿度センサを離れたところで使いたい場合、高湿度環境で使う場合はHS15P湿度センサは有用だと思います。
ただし、反応速度が遅いことを許容できるのであればですが。

## 接続
以下のように接続します。vfPin、vaPin、vrPinはArduinoのピンでコンストラクタで指定します。  
コンデンサはフィルムコンデンサ等容量の安定性が良いものを使います。
````
!        _____            _______
        |HS15P|          |0.022uF|
        |_____|          |_______|
         |   |             |   |
  +------+   +------+------+   +-------+
  |                 |                  |
vfPin             vaPin              vrPin
````
資料１，２、３ではvrPinはGNDですが、本ライブラリではセンサの非対称化防止対策として疑似交流化しているため、デジタルピンを使います。
なお、湿度の計算には温度補正が必要ですので、恒温条件でない限り別途温度センサも必要です。

## コンストラクタ
```
HS15P hs15p(int vfPin, int vrPin, int vaPin, vdPin);
```
Arduinoに接続するピンを指定します。
* vfPin:デジタルピン（Arduino Uno R3では2~13）
* vrPin:デジタルピン（Arduino Uno R3では2~13）
* vaPin:アナログピン（Arduino Uno R3では0~5）
* vdPin:vaPinをデジタルピンとして使う場合のピン番号（Arduino Uno R3では14~19）

## 機能
```
float getRh(float temp);
```
HS15Pで測定を行い、引数tempで指定した温度（℃）を基に計算した湿度（％）を返します。

```
void setFactor(float factor);
```
HS15P等の個体差補正のためのfactor値を設定します（既定値: 1.00）。**校正**を参照してください。

```
float getFactor();
```
現在のfactor値を返します。

```
float getVPD(float temp, float rh);
```
引数で指定した温度 temp（℃）、相対湿度 rh（％）から飽差（Vapor pressure deficit）を計算して返します（hPa）。
飽和水蒸気圧の計算にTetens(1930)の計算式を使っています。

## 校正
外れ個体でなければ校正無しでも精度５％位はあると思いますが、保証はありません。できればHS15P個体ごとに校正（factor値の調整）してください。
塩飽和法（飽和塩化ナトリウムで75.3%@25℃等）、アースマン通風乾湿計、他の精度保証された湿度センサ等で校正します。
実際の湿度より高い値を返す場合はfactorを大きく、低い値を返す場合はfactorを小さくします。よほど外れの個体でない限り 0.50~1.50 で補正できると思います。
なお、現在の変換式は３０℃以上で精度が劣ります。いずれ改良したいと思います。

## 参考資料等
スケッチ作成にあたっては、以下のサイトを参考にいたしました。特に資料１は本ライブラリで使っているHS15P駆動方法の開発に関する重要資料です。これが無かったら本ライブラリはできませんでした。HS15Pを使われるのであれば資料１は一度読まれることを勧めます。

[HS15P 湿度センサーの簡易動作実験](http://siesta.la.coocan.jp/zk/hs15/hs15.html)（資料１）

[HS15P 湿度センサーの簡易動作実験 Arduino版](http://siesta.la.coocan.jp/zk/hs15/hs15_arduino.html)（資料２）

[Arduino温湿度測定ロガー・湿度センサーの比較](https://bokunimo.net/arduino/humidity.html)（資料３）

他にもネットの情報をいろいろ参考にしました。

## 履歴
### 1.0.0 - Sep. 5, 2020 
### 1.0.1 - Sep. 6, 2020 bug fix

## 著作権
(c) citriena (citriena@yahoo.co.jp)

本ライブラリはライセンスフリーです。

## 再配布
再配布については下記の著作者の承諾を得る必要があります。
（本ソフトウェアの湿度センサHS15P測定ルーチンは下記の検討結果を基にしています）

[HS15湿度センサーと簡易回路による湿度計実験 渡波 郁](http://siesta.la.coocan.jp/zk/hs15/hs15.html)

## 参考・補足情報

本ライブラリは上記の資料１、資料２、資料３からいくつか変更を行なっています。

### レンジ切替時の不連続性対応
参考資料３の湿度ルーチンでは充電時間のレンジ切換時に湿度の値が不連続になります。資料２では充電時間を5us短くする補正をしてあるからか
大きなズレはありませんが、資料３では５％程度ずれることもありました。そこで、測定原理をもとに以下のような調整を行いました。

資料１で計算すると、1kΩ (9.4us), 10kΩ (94us), 100kΩ (940us), 1MΩ (9400us)時のアナログ計測値は、いずれも356となるはずです
（1024\*(1-exp(-0.0000094/(0.000000022\*1000)))）。しかし、HS15Pの代わりに金属皮膜抵抗で実測するとこの値になりません。
値が356でなくても同じ値なら問題ありませんが、レンジにより異なります。
このレンジによる値の違いがレンジ切替時の不連続の原因と考えられますので、上記のアナログ計測値が一致するように充電時間をレンジ毎に調整すればレンジ境界のずれは無くなるはずです。

ここで問題があります。10us（計算は資料１で開発に使ってあるATtiny13Aの実情に合わせて9.4us）のレンジは充電時間の細かい調整ができないということです。
そこで、1kΩ時にアナログ計測値が356に近い充電時間を見つけ、その後同様に10kΩ、100kΩ、1MΩで計測値がその値とほぼ一致するように充電時間を調整することにしました。
今回は1kΩ, 6usでアナログ計測値362でした。このため、全てのレンジでアナログ計測値が362に近くなるように充電時間を調整しました。
ただし、充電時間を調整したため、抵抗の計算値がずれることになります。そこで、計測値が362になる充電時間を算出し、抵抗値の計算に使うようにしました。
今回は1kΩで9.38usです。この調整により抵抗の計算値が補正されます。
実際にセンサを使って測定すると、レンジ境界のずれは１％以下に収まるようになりました。

### 個体差補正

#### Arduinoの個体差
Arduino UNO R3をいくつか換えて測定してみたところ、測定値に違いはほとんど見られませんでした。このため、Arduinoの個体差は考慮から除外しました。

#### コンデンサの個体差
コンデンサの容量は測定値に影響します。そこで複数のコンデンサで調べた見たところ、アナログ計測値で5前後の違いがありました。
湿度への影響は１％程度です。通常は次に述べるHS15Pの個体差補正で一緒に補正できますので、これも考慮から除外することにします。
事前にある装置でHS15Pの補正値(factor)を求めておき、それを別の装置に使う場合は影響が出る可能性があります。

#### HS15Pの個体差補正
測定値に最も影響するのがHS15Pの個体差です。データシートでは25℃50%RH時のインピーダンスは60kohm±30kohm (±5%RH)となっています。
このため、係数（factor値）で個体差を補正できるようにしました。実際よりも湿度が高く表示される場合はfactor値を大きくします。

実際に調べてみたところ多くは湿度で3%程度程度の小さな個体差ですが、まれに特性が大きく異なる個体があります。
私が10個調べた中には、湿度で15％以上異なるものが１個、10％程度異なるものが1個ありました。

### センサの非対称化（分極？）解消
一晩使うと電圧計測ピン（vaPin）になぜか数十カウントの電圧が残るようになりました（残らない個体もあります）。
HS15Pのピンを入れ替えると電圧は残らなくなります（が数値は異なります）。気持ち悪いので、この症状を
抑制することにしました。まず、測定後にHIにするピンを入れ替え、疑似交流化してみました。これにより
長期使用しても計測時に電圧は残らなくなりましたが、今度は逆にセンサのピンを入れ替えると電圧が残るように
なりました。計測値もピンを入れ替える前とずれが生じます。そこでさらに測定後は電圧計測ピンをLOに落とす
ことにしてみした。しかし、症状は改善しません。いろいろ試してみたところ、測定後の電圧計測ピンLOを止め、
測定前の放電時に電圧計測ピンをLOにしたところ、センサのピンを入れ替えた時のずれがほぼなくなりました。電
圧が残る場合もありますが僅かであり、また数分以内にほぼ同じ値を示します。対処療法であり根本的
な解決ではないかもしれませんが、とりあえずはこれで様子を見ることにします。
